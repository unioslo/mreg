# Generated by Django 5.0.9 on 2025-01-29 09:40

import django.db.models.deletion
import mreg.fields
from django.db import migrations, models

def create_protected_attributes(apps, schema_editor):
    """Ensures the 'isolated' attribute is always created."""
    NetworkPolicyAttribute = apps.get_model("mreg", "NetworkPolicyAttribute")
    NetworkPolicyAttribute.objects.get_or_create(
        name="isolated",
        defaults={"description": "The network uses client isolation"},
    )

class Migration(migrations.Migration):

    dependencies = [
        ('mreg', '0013_migrate_away_from_ci_fields'),
    ]

    operations = [
        migrations.CreateModel(
            name='Community',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('name', mreg.fields.LowerCaseCharField(help_text='Policy-unique name of the community.', max_length=100)),
                ('description', models.CharField(blank=True, help_text='Description of the community.', max_length=250)),
            ],
            options={
                'ordering': ('name',),
            },
        ),
        migrations.CreateModel(
            name='NetworkPolicy',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('name', mreg.fields.LowerCaseCharField(help_text='Name of the network policy.', max_length=100, unique=True)),
                ('description', models.TextField(blank=True, help_text='Description of the network policy.')),
            ],
            options={
                'abstract': False,
            },
        ),
        migrations.CreateModel(
            name='NetworkPolicyAttribute',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('name', mreg.fields.LowerCaseCharField(max_length=100, unique=True)),
                ('description', models.TextField(blank=True, help_text='Description of the attribute.')),
            ],
            options={
                'abstract': False,
            },
        ),
        migrations.RunPython(create_protected_attributes),
        migrations.AddField(
            model_name='host',
            name='network_community',
            field=models.ForeignKey(blank=True, help_text='Network community this host belongs to.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='hosts', to='mreg.community'),
        ),
        migrations.AddField(
            model_name='community',
            name='policy',
            field=models.ForeignKey(help_text='The network policy this community is associated with.', on_delete=django.db.models.deletion.CASCADE, related_name='communities', to='mreg.networkpolicy'),
        ),
        migrations.AddField(
            model_name='network',
            name='policy',
            field=models.ForeignKey(blank=True, help_text='Optional policy applied to the network.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='networks', to='mreg.networkpolicy'),
        ),
        migrations.CreateModel(
            name='NetworkPolicyAttributeValue',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('value', models.BooleanField(default=False, help_text='Value of the attribute for this network policy.')),
                ('attribute', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='network_policy_attribute_values', to='mreg.networkpolicyattribute')),
                ('policy', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='network_policy_attribute_values', to='mreg.networkpolicy')),
            ],
            options={
                'verbose_name': 'Policy Attribute Value',
                'verbose_name_plural': 'Policy Attribute Values',
                'unique_together': {('policy', 'attribute')},
            },
        ),
        migrations.AddField(
            model_name='networkpolicy',
            name='attributes',
            field=models.ManyToManyField(help_text='Attributes associated with this policy.', related_name='policies', through='mreg.NetworkPolicyAttributeValue', to='mreg.networkpolicyattribute'),
        ),
        migrations.AlterUniqueTogether(
            name='community',
            unique_together={('name', 'policy')},
        ),
    ]
